<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Badminton Expenses</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">üè∏ Uncle Group Badminton Expenses</h1>
      <div>
        <button id="adminToggle" class="text-sm px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Admin</button>
      </div>
    </header>

    <section class="grid md:grid-cols-2 gap-6">
      <!-- Balances -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Balances</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="balancesTable">
            <thead>
              <tr class="bg-gray-100">
                <th class="text-left px-3 py-2">Player</th>
                <th class="text-right px-3 py-2">Owed</th>
                <th class="text-right px-3 py-2">Paid</th>
                <th class="text-right px-3 py-2">Balance</th>
              </tr>
            </thead>
            <tbody id="balancesBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Per-Player Total Attendance (Chart) -->
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Total Attendance by Player</h2>
          <select id="playerChartLimit" class="border rounded px-2 py-1 text-sm">
            <option value="10" selected>Top 10</option>
            <option value="20">Top 20</option>
            <option value="50">Top 50</option>
            <option value="0">All</option>
          </select>
        </div>

        <div id="playerChartWrapper" style="max-height: 620px; overflow:auto;">
          <canvas id="playerAttendanceChart"></canvas>
        </div>

        <p id="playerChartEmpty" class="text-sm text-gray-500 hidden">
          No attendance yet. Add some sessions in Admin ‚Üí Attendance.
        </p>

        <p class="text-xs text-gray-500 mt-2">
          Totals include <em>slots</em> (so +2 guests count as 2).
        </p>
      </div>

      <!-- Attendance (PUBLIC) -->
      <div class="bg-white rounded-2xl shadow p-4 md:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Attendance</h2>
          <div class="flex items-center gap-3">
            <div class="space-x-2">
              <button id="pubAttPrev" class="px-2 py-1 border rounded">Prev</button>
              <span id="pubAttPageInfo" class="text-sm text-gray-600">1 / 1 (0)</span>
              <button id="pubAttNext" class="px-2 py-1 border rounded">Next</button>
            </div>
            <label class="text-sm text-gray-600">
              Page size
              <select id="pubAttPageSize" class="border rounded px-2 py-1">
                <option>5</option><option selected>10</option><option>20</option><option>50</option>
              </select>
            </label>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="attendanceTable">
            <thead>
              <tr class="bg-gray-100">
                <th class="text-left px-3 py-2">Date</th>
                <th class="text-left px-3 py-2">Player</th>
                <th class="text-right px-3 py-2">Slots (+1/+2)</th>
              </tr>
            </thead>
            <tbody id="attendanceBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Payments (PUBLIC) -->
      <div class="bg-white rounded-2xl shadow p-4 md:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Payments</h2>
          <div class="flex items-center gap-3">
            <div class="space-x-2">
              <button id="pubPayPrev" class="px-2 py-1 border rounded">Prev</button>
              <span id="pubPayPageInfo" class="text-sm text-gray-600">1 / 1 (0)</span>
              <button id="pubPayNext" class="px-2 py-1 border rounded">Next</button>
            </div>
            <label class="text-sm text-gray-600">
              Page size
              <select id="pubPayPageSize" class="border rounded px-2 py-1">
                <option>5</option><option selected>10</option><option>20</option><option>50</option>
              </select>
            </label>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="paymentsTable">
            <thead>
              <tr class="bg-gray-100">
                <th class="text-left px-3 py-2">Date</th>
                <th class="text-left px-3 py-2">Player</th>
                <th class="text-right px-3 py-2">Amount</th>
                <th class="text-left px-3 py-2">Note</th>
              </tr>
            </thead>
            <tbody id="paymentsBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Matches by Session -->
      <div class="bg-white rounded-2xl shadow p-4 md:col-span-2 mt-6">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Matches (by Session)</h2>
          <div class="flex items-center gap-2">
            <label class="text-sm">Date</label>
            <input type="date" id="pubMatchDate" class="border rounded px-2 py-1" />
            <button id="pubLoadMatches" class="px-3 py-1 rounded bg-gray-200">Load</button>
          </div>
        </div>

        <div id="pubMatchesContainer" class="space-y-3"></div>
      </div>

      <!-- Player Error Stats (for selected date) -->
      <div class="bg-white rounded-2xl shadow p-4 md:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Player Error Stats</h2>
          <div class="text-sm text-gray-500" id="pubStatsDateLabel"></div>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="bg-gray-100">
                <th class="text-left px-3 py-2">Player</th>
                <th class="text-left px-3 py-2">Reason</th>
                <th class="text-right px-3 py-2">Count</th>
              </tr>
            </thead>
            <tbody id="pubPlayerStatsBody"></tbody>
          </table>
        </div>
      </div>      

    </section>

    <!-- Admin Panel (hidden until toggled) -->
    <section id="adminPanel" class="mt-8 hidden">
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Admin</h2>
          <div class="space-x-2">
            <button id="signInBtn" class="px-3 py-2 rounded bg-blue-600 text-white text-sm">Sign in</button>
            <button id="signOutBtn" class="px-3 py-2 rounded bg-gray-200 text-sm">Sign out</button>
          </div>
        </div>
        <p id="authStatus" class="text-sm text-gray-600 mt-2">Not signed in</p>
        <hr class="my-4"/>

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Add Player -->
          <form id="playerForm" class="space-y-2">
            <h3 class="font-medium">Add Player</h3>
            <input class="w-full border rounded px-3 py-2" placeholder="Name" name="name" required />
            <input class="w-full border rounded px-3 py-2" placeholder="Email (optional)" name="email" />
            <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Add Player</button>
            <p class="text-xs text-gray-500">Active by default. Unique names.</p>
          </form>

          <!-- Add Expense -->
          <form id="expenseForm" class="space-y-2">
            <h3 class="font-medium">Add Expense (Court/Balls etc.)</h3>
            <input type="date" class="w-full border rounded px-3 py-2" name="date" required />
            <input type="number" step="0.01" class="w-full border rounded px-3 py-2" placeholder="Amount" name="amount" required />
            <input class="w-full border rounded px-3 py-2" placeholder="Description" name="description" />
            <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Add Expense</button>
          </form>

          <!-- Add Attendance -->
          <form id="attendanceForm" class="space-y-2">
            <h3 class="font-medium">Add Attendance</h3>
            <input type="date" class="w-full border rounded px-3 py-2" name="date" required />
            <select class="w-full border rounded px-3 py-2" name="player_id" id="attPlayer" required></select>
            <input type="number" class="w-full border rounded px-3 py-2" placeholder="Slots (1 or 2)" name="slots" min="1" value="1" required />
            <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Add/Update Attendance</button>
            <p class="text-xs text-gray-500">Unique per (date, player). Re-submit to update slots.</p>
          </form>

          <!-- Add Payment -->
          <form id="paymentForm" class="space-y-2">
            <h3 class="font-medium">Add Payment</h3>
            <input type="date" class="w-full border rounded px-3 py-2" name="date" required />
            <select class="w-full border rounded px-3 py-2" name="player_id" id="payPlayer" required></select>
            <input type="number" step="0.01" class="w-full border rounded px-3 py-2" placeholder="Amount" name="amount" required />
            <input class="w-full border rounded px-3 py-2" placeholder="Note" name="note" />
            <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Add Payment</button>
          </form>

          <!-- SCORING -->
          <div class="bg-white rounded-2xl shadow p-4 md:col-span-2 mt-6">
            <h3 class="font-medium mb-3">Match Scoring (Doubles, to 21)</h3>

            <!-- Setup -->
            <div class="grid md:grid-cols-3 gap-4">
              <div>
                <label class="text-sm">Session Date</label>
                <input type="date" id="sc_date" class="w-full border rounded px-3 py-2" />
                <label class="text-sm mt-2 block">Notes (optional)</label>
                <input id="sc_note" class="w-full border rounded px-3 py-2" placeholder="e.g., Court 8 PIN 29610" />
              </div>

              <div>
                <label class="text-sm">Team A players</label>
                <select id="sc_teamA_players" class="w-full border rounded px-3 py-2" multiple size="4"></select>
                <label class="text-sm mt-2 block">Team 1 name</label>
                  <input id="sc_teamA_name" class="w-full border rounded px-3 py-2" value="Team A" />
                <div class="flex gap-2 mt-2">
                  <input id="sc_teamA_guest" class="flex-1 border rounded px-3 py-2" placeholder="Add guest name" />
                  <button id="sc_teamA_addGuest" class="px-3 py-2 rounded bg-gray-200">Add</button>
                </div>
                <div id="sc_teamA_guestList" class="text-xs text-gray-600 mt-1"></div>
              </div>

              <div>
                <label class="text-sm">Team B players</label>
                <select id="sc_teamB_players" class="w-full border rounded px-3 py-2" multiple size="4"></select>
                <label class="text-sm mt-2 block">Team 2 name</label>
                <input id="sc_teamB_name" class="w-full border rounded px-3 py-2" value="Team B" />
                <div class="flex gap-2 mt-2">
                  <input id="sc_teamB_guest" class="flex-1 border rounded px-3 py-2" placeholder="Add guest name" />
                  <button id="sc_teamB_addGuest" class="px-3 py-2 rounded bg-gray-200">Add</button>
                </div>
                <div id="sc_teamB_guestList" class="text-xs text-gray-600 mt-1"></div>
              </div>
            </div>

            <div class="mt-3">
              <button id="sc_createMatch" class="px-4 py-2 rounded bg-emerald-600 text-white">Create / Start Match</button>
              <span id="sc_status" class="text-sm text-gray-600 ml-2"></span>
            </div>

            <hr class="my-4" />

            <!-- Live scoring -->
            <div id="sc_live" class="hidden">
              <div class="flex items-center justify-between">
                <div class="text-lg font-semibold">
                  <span id="sc_teamA_name">Team A</span>
                  <span id="sc_scoreA" class="ml-2 text-2xl">0</span>
                  <span class="mx-2">‚Äì</span>
                  <span id="sc_scoreB" class="mr-2 text-2xl">0</span>
                  <span id="sc_teamB_name">Team B</span>
                </div>
                <div class="text-sm text-gray-600">Match ID: <span id="sc_matchId">‚Äì</span></div>
              </div>

              <div class="mt-4 grid md:grid-cols-4 gap-3">
                <div class="md:col-span-2 flex gap-2">
                  <button id="sc_pointA" class="px-4 py-2 rounded bg-blue-600 text-white">+1 Team A</button>
                  <button id="sc_pointB" class="px-4 py-2 rounded bg-indigo-600 text-white">+1 Team B</button>
                  <button id="sc_undo" class="px-4 py-2 rounded bg-gray-200">Undo</button>
                  <button id="sc_finish" class="px-4 py-2 rounded bg-emerald-600 text-white">Finish Match</button>
                  <label class="flex items-center gap-1 text-sm text-gray-600">
                    <input type="checkbox" id="sc_force" />
                    Force finish
                  </label>
                </div>

                <div>
                  <label class="text-sm">Reason</label>
                  <select id="sc_reason" class="w-full border rounded px-3 py-2">
                    <option value="rally">Rally won</option>
                    <option value="service_error">Service error</option>
                    <option value="unforced_error">Unforced error</option>
                    <option value="out">Shuttle out</option>
                    <option value="net">Net</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div>
                  <label class="text-sm">Error by (optional)</label>
                  <select id="sc_error_player" class="w-full border rounded px-3 py-2">
                    <option value="">‚Äî</option>
                  </select>
                </div>
              </div>

              <div class="mt-3">
                <input id="sc_event_note" class="w-full border rounded px-3 py-2" placeholder="Note (optional)" />
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <footer class="text-xs text-gray-500 mt-8">Built with Supabase + Tailwind. Static hosting friendly.</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2.45.4";

    // === CONFIG: Replace with your Supabase project details ===
    const SUPABASE_URL = "https://ioxtxbgqaognzxscgkly.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlveHR4YmdxYW9nbnp4c2Nna2x5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNTgxMDksImV4cCI6MjA3NTczNDEwOX0.oIST2TVUJbg4H0PziuNdLBcSHFERkkM2M29bHpsYE-E";
    
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      console.error("Supabase URL/key missing");
    }
    // Init Supabase
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true, // needed for magic-link callback
      },
    });
    window.supabase = supabase;
    // MUST match Supabase Auth ‚Üí URL Configuration ‚Üí (Site URL + Redirect URL)
    const SITE_URL = "https://kailashr2k3.github.io/uncle-group-badminton-expenses/"; // keep the trailing slash
    /* ===== Init ===== */
    //const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ===== UI handles ===== */
    const balancesBody = document.getElementById('balancesBody');
    const attendanceBody = document.getElementById('attendanceBody');
    const paymentsBody = document.getElementById('paymentsBody');
    const adminPanel = document.getElementById('adminPanel');
    const adminToggle = document.getElementById('adminToggle');
    const authStatus = document.getElementById('authStatus');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const attPlayer = document.getElementById('attPlayer');
    const payPlayer = document.getElementById('payPlayer');

    /* ===== Admin toggle/auth ===== */
    adminToggle.addEventListener('click', async () => {
      adminPanel.classList.toggle('hidden');
      if (!adminPanel.classList.contains('hidden')) {
        updateAuthStatus();
        const user = await getUser();
        if (!user) { await signInFlow(); }
      }
    });

    signInBtn?.addEventListener('click', signInFlow);
    signOutBtn?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      updateAuthStatus();
    });

    async function getUser() {
      const { data: { user } } = await supabase.auth.getUser();
      return user || null;
    }

    async function signInFlow() {
      const email = prompt("Enter your admin email to receive a sign-in link:");
      if (!email) return;
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: SITE_URL }
      });
      if (error) alert(error.message);
      else alert("Magic link sent! Check your inbox.");
    }

    async function updateAuthStatus() {
      const { data: { user } } = await supabase.auth.getUser();
      authStatus.textContent = user ? `Signed in as ${user.email}` : 'Not signed in';
    }

    /* ===== Chart helpers ===== */
    let playerAttendanceChart;

    function groupAttendanceByPlayer(rows) {
      const map = new Map();
      for (const r of rows || []) {
        const name = r?.players?.name ?? 'Unknown';
        const slots = Number(r?.slots ?? 0);
        if (slots > 0) map.set(name, (map.get(name) || 0) + slots);
      }
      return [...map.entries()].sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));
    }

    function renderPlayerAttendanceChart(rows, limit = 10) {
      const canvas = document.getElementById('playerAttendanceChart');
      const wrapper = document.getElementById('playerChartWrapper');
      const emptyMsg = document.getElementById('playerChartEmpty');
      if (!canvas || !wrapper || !emptyMsg) return;

      let data = groupAttendanceByPlayer(rows);

      if (!data.length) {
        wrapper.classList.add('hidden');
        emptyMsg.classList.remove('hidden');
        if (playerAttendanceChart) { playerAttendanceChart.destroy(); playerAttendanceChart = null; }
        return;
      } else {
        wrapper.classList.remove('hidden');
        emptyMsg.classList.add('hidden');
      }

      if (limit && limit > 0) data = data.slice(0, limit);

      const labels = data.map(([name]) => name);
      const values = data.map(([, total]) => total);

      const perBar = 28, minH = 240, maxH = 700;
      canvas.height = Math.max(minH, Math.min(maxH, labels.length * perBar));

      if (playerAttendanceChart) playerAttendanceChart.destroy();

      playerAttendanceChart = new Chart(canvas, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Total attendance (slots)', data: values }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          scales: {
            x: { beginAtZero: true, title: { display: true, text: 'Slots' } },
            y: { ticks: { autoSkip: false } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'nearest', intersect: false },
            datalabels: {
              anchor: 'end',
              align: 'right',
              color: '#111',
              font: { weight: 'bold' },
              formatter: (value, context) => {
                const name = context.chart.data.labels[context.dataIndex];
                return `${name}: ${value}`;
              },
              clip: false
            }
          },
          layout: { padding: { right: 8 } }
        },
        plugins: [ChartDataLabels]
      });
    }

    document.addEventListener('change', (e) => {
      if (e.target?.id === 'playerChartLimit') {
        const limit = Number(e.target.value);
        renderPlayerAttendanceChart(window.__lastAttendanceRows || [], limit);
      }
    });

    /* ===== Data fetch ===== */
    async function fetchPlayers() {
      const { data, error } = await supabase.from('players').select('*').order('name');
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function fetchAttendance() {
      const { data, error } = await supabase
        .from('attendance')
        .select('id,date,slots,player_id,players(name)')
        .order('date', { ascending: false });
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function fetchPayments() {
      const { data, error } = await supabase
        .from('payments')
        .select('id,date,amount,note,player_id,players(name)')
        .order('date', { ascending: false });
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function fetchBalances() {
      const { data, error } = await supabase
        .from('balance_view')
        .select('*')
        .order('name');
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function fetchMatchSummaryByDate(dateStr) {
      // summary has team names + scores + winner
      const { data, error } = await supabase
        .from('match_summary')
        .select('*')
        .eq('date', dateStr)
        .order('created_at', { ascending: false });
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function fetchRostersByMatchIds(matchIds) {
      if (!matchIds.length) return [];
      const { data, error } = await supabase
        .from('match_team_roster')
        .select('*')
        .in('match_id', matchIds);
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function fetchEventsByMatch(matchId) {
      const { data, error } = await supabase
        .from('match_events')
        .select('seq, scoring_team_id, reason, error_player_id, note, created_at')
        .eq('match_id', matchId)
        .order('seq', { ascending: true });
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function fetchPlayerErrorStatsByDate(dateStr) {
      const { data, error } = await supabase
        .from('player_error_stats_by_date')
        .select('*')
        .eq('date', dateStr)
        .order('player_name', { ascending: true });
      if (error) { console.error(error); return []; }
      return data || [];
    }

    function renderPlayerErrorStats(dateStr, rows) {
      document.getElementById('pubStatsDateLabel').textContent = dateStr ? `Date: ${dateStr}` : '';
      const body = document.getElementById('pubPlayerStatsBody');
      if (!body) return;
      if (!rows || !rows.length) {
        body.innerHTML = `<tr><td class="px-3 py-2" colspan="3">No error stats.</td></tr>`;
        return;
      }
      body.innerHTML = rows.map(r => `
        <tr class="border-b last:border-0">
          <td class="px-3 py-2">${r.player_name}</td>
          <td class="px-3 py-2">${r.reason.replaceAll('_',' ')}</td>
          <td class="px-3 py-2 text-right">${r.reason_count}</td>
        </tr>
      `).join('');
    }

    function renderMatchesByDate(dateStr, summaryRows, rosters) {
      const host = document.getElementById('pubMatchesContainer');
      if (!host) return;

      if (!summaryRows.length) {
        host.innerHTML = `<div class="text-sm text-gray-500">No matches for ${dateStr}.</div>`;
        return;
      }

      const rosterByTeam = new Map();
      for (const r of rosters) {
        rosterByTeam.set(r.team_id, {
          players: r.players || '',
          guests: r.guests || ''
        });
      }

      host.innerHTML = summaryRows.map(s => {
        const r1 = rosterByTeam.get(s.team1_id) || {};
        const r2 = rosterByTeam.get(s.team2_id) || {};
        const winnerBadge = s.winner_name ? `<span class="ml-2 text-xs rounded bg-emerald-100 text-emerald-800 px-2 py-0.5">Winner: ${s.winner_name}</span>` : '';

        return `
          <details class="rounded border p-3">
            <summary class="cursor-pointer list-none">
              <div class="flex items-center justify-between">
                <div class="font-medium">
                  ${s.team1_name} <span class="font-semibold">${s.team1_points}</span>
                  <span class="mx-2">‚Äì</span>
                  <span class="font-semibold">${s.team2_points}</span> ${s.team2_name}
                  ${winnerBadge}
                </div>
                <div class="text-xs text-gray-500">${s.status === 'finished' ? 'Finished' : 'Open'} ‚Ä¢ ${s.date}</div>
              </div>
              <div class="text-xs text-gray-600 mt-1">
                <b>${s.team1_name}</b>:
                ${r1.players ? r1.players : ''}${r1.guests ? (r1.players ? '; ' : '') + `Guests: ${r1.guests}` : ''}
                &nbsp;&nbsp;|&nbsp;&nbsp;
                <b>${s.team2_name}</b>:
                ${r2.players ? r2.players : ''}${r2.guests ? (r2.players ? '; ' : '') + `Guests: ${r2.guests}` : ''}
              </div>
            </summary>

            <div class="mt-3" id="match-${s.match_id}-events">
              <div class="text-xs text-gray-500">Loading rallies‚Ä¶</div>
            </div>
          </details>
        `;
      }).join('');

      // lazy-load each match's event list (point-by-point)
      summaryRows.forEach(async (s) => {
        const events = await fetchEventsByMatch(s.match_id);
        const mount = document.getElementById(`match-${s.match_id}-events`);
        if (!mount) return;
        if (!events.length) {
          mount.innerHTML = `<div class="text-sm text-gray-500">No rallies recorded.</div>`;
          return;
        }
        const rows = events.map(ev => {
          const team = ev.scoring_team_id === s.team1_id ? s.team1_name : s.team2_name;
          const reason = (ev.reason || '').replaceAll('_',' ');
          const note = ev.note || '';
          return `
            <tr class="border-b last:border-0">
              <td class="px-3 py-1">${ev.seq}</td>
              <td class="px-3 py-1">${team}</td>
              <td class="px-3 py-1">${reason}</td>
              <td class="px-3 py-1">${note}</td>
            </tr>`;
        }).join('');
        mount.innerHTML = `
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="bg-gray-100">
                  <th class="text-left px-3 py-2">#</th>
                  <th class="text-left px-3 py-2">Scoring Team</th>
                  <th class="text-left px-3 py-2">Reason</th>
                  <th class="text-left px-3 py-2">Note</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>`;
      });
    }

    /* ===== Public pagination (Attendance/Payments only) ===== */
    const PUB_ATT = { data: [], page: 1, pageSize: 10 };
    const PUB_PAY = { data: [], page: 1, pageSize: 10 };

    function paginate(arr, page, size) {
      const start = (page - 1) * size;
      return arr.slice(start, start + size);
    }

    function renderPublicAttendance() {
      const container = document.getElementById('attendanceBody');
      if (!container) return;

      const total = PUB_ATT.data.length;
      const pages = Math.max(1, Math.ceil(total / PUB_ATT.pageSize));
      PUB_ATT.page = Math.min(Math.max(1, PUB_ATT.page), pages);

      const rows = paginate(PUB_ATT.data, PUB_ATT.page, PUB_ATT.pageSize);
      container.innerHTML = rows.map(r => `
        <tr class="border-b last:border-0">
          <td class="px-3 py-2">${r.date}</td>
          <td class="px-3 py-2">${r.players?.name ?? r.player_id}</td>
          <td class="px-3 py-2 text-right">${r.slots}</td>
        </tr>
      `).join('');

      const info = document.getElementById('pubAttPageInfo');
      if (info) info.textContent = `${PUB_ATT.page} / ${pages} (${total})`;
      document.getElementById('pubAttPrev').disabled = PUB_ATT.page <= 1;
      document.getElementById('pubAttNext').disabled = PUB_ATT.page >= pages;
    }

    function renderPublicPayments() {
      const container = document.getElementById('paymentsBody');
      if (!container) return;

      const total = PUB_PAY.data.length;
      const pages = Math.max(1, Math.ceil(total / PUB_PAY.pageSize));
      PUB_PAY.page = Math.min(Math.max(1, PUB_PAY.page), pages);

      const rows = paginate(PUB_PAY.data, PUB_PAY.page, PUB_PAY.pageSize);
      container.innerHTML = rows.map(r => `
        <tr class="border-b last:border-0">
          <td class="px-3 py-2">${r.date}</td>
          <td class="px-3 py-2">${r.players?.name ?? r.player_id}</td>
          <td class="px-3 py-2 text-right">$${Number(r.amount).toFixed(2)}</td>
          <td class="px-3 py-2">${r.note ?? ''}</td>
        </tr>
      `).join('');

      const info = document.getElementById('pubPayPageInfo');
      if (info) info.textContent = `${PUB_PAY.page} / ${pages} (${total})`;
      document.getElementById('pubPayPrev').disabled = PUB_PAY.page <= 1;
      document.getElementById('pubPayNext').disabled = PUB_PAY.page >= pages;
    }

    // Wire public pager controls
    document.addEventListener('DOMContentLoaded', () => {
      // Attendance
      document.getElementById('pubAttPrev').onclick = () => {
        if (PUB_ATT.page > 1) { PUB_ATT.page--; renderPublicAttendance(); }
      };
      document.getElementById('pubAttNext').onclick = () => {
        PUB_ATT.page++; renderPublicAttendance();
      };
      document.getElementById('pubAttPageSize').onchange = (e) => {
        PUB_ATT.pageSize = Number(e.target.value || 10);
        PUB_ATT.page = 1;
        renderPublicAttendance();
      };

      // Payments
      document.getElementById('pubPayPrev').onclick = () => {
        if (PUB_PAY.page > 1) { PUB_PAY.page--; renderPublicPayments(); }
      };
      document.getElementById('pubPayNext').onclick = () => {
        PUB_PAY.page++; renderPublicPayments();
      };
      document.getElementById('pubPayPageSize').onchange = (e) => {
        PUB_PAY.pageSize = Number(e.target.value || 10);
        PUB_PAY.page = 1;
        renderPublicPayments();
      };
    });

    /* ===== Render helpers ===== */
    function renderPlayers(players) {
      const attSel = document.getElementById('attPlayer');
      const paySel = document.getElementById('payPlayer');
      const opts = players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      if (attSel) attSel.innerHTML = '<option value="" disabled selected>Select player</option>' + opts;
      if (paySel) paySel.innerHTML = '<option value="" disabled selected>Select player</option>' + opts;
    }

    function renderBalances(rows) {
      balancesBody.innerHTML = rows.map(r => {
        const bal = Number(r.balance);
        const cls =
          bal < 0 ? 'text-red-600' :        // owes money
          bal > 0 ? 'text-emerald-700' :    // has credit
          'text-gray-500';                  // settled

        const sign = bal > 0 ? '+' : '';    // optional + sign

        return `
          <tr class="border-b last:border-0">
            <td class="px-3 py-2">${r.name}</td>
            <td class="px-3 py-2 text-right">$${Number(r.total_owed).toFixed(2)}</td>
            <td class="px-3 py-2 text-right">$${Number(r.total_paid).toFixed(2)}</td>
            <td class="px-3 py-2 text-right font-semibold ${cls}">
              ${sign}$${bal.toFixed(2)}
            </td>
          </tr>`;
      }).join('');
    }

    /* ===== Initial load ===== */
    async function refreshAll() {
      updateAuthStatus();
      const [players, attendance, payments, balances] = await Promise.all([
        fetchPlayers(), fetchAttendance(), fetchPayments(), fetchBalances()
      ]);

      renderPlayers(players);
      renderBalances(balances);

      // public datasets + first render
      PUB_ATT.data = attendance || [];
      PUB_PAY.data = payments  || [];
      renderPublicAttendance();
      renderPublicPayments();

      // chart
      window.__lastAttendanceRows = attendance;
      const limitSel = document.getElementById('playerChartLimit');
      const limit = limitSel ? Number(limitSel.value) : 10;
      renderPlayerAttendanceChart(attendance, limit);
    }

    /* ========= SCORING STATE ========= */
    const SC = {
      matchId: null,
      teamA: null, teamB: null,
      teamA_name: 'Team A', teamB_name: 'Team B',
      teamA_guests: [],
      teamB_guests: [],
      seq: 0, // will be derived from DB
    };

    /* ========= HELPERS ========= */
    function fillMultiSelectPlayers(selEl, players) {
      selEl.innerHTML = players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
    }
    function renderGuestLists() {
      document.getElementById('sc_teamA_guestList').textContent = SC.teamA_guests.length
        ? 'Guests: ' + SC.teamA_guests.join(', ')
        : '';
      document.getElementById('sc_teamB_guestList').textContent = SC.teamB_guests.length
        ? 'Guests: ' + SC.teamB_guests.join(', ')
        : '';
    }
    async function getCurrentScore(match_id) {
      const { data, error } = await supabase
        .from('match_events')
        .select('scoring_team_id')
        .eq('match_id', match_id)
        .order('seq', { ascending: true });
      if (error) { console.error(error); return { a:0, b:0, seq:0 }; }
      let a=0, b=0, seq=0;
      for (const r of data) {
        seq++;
        if (r.scoring_team_id === SC.teamA) a++; else if (r.scoring_team_id === SC.teamB) b++;
      }
      return { a, b, seq };
    }
    function updateScoreUI(a, b) {
      document.getElementById('sc_scoreA').textContent = a;
      document.getElementById('sc_scoreB').textContent = b;
    }

    /* ========= CREATE / START MATCH ========= */
    document.getElementById('sc_teamA_addGuest').onclick = () => {
      const v = document.getElementById('sc_teamA_guest').value.trim();
      if (v) { SC.teamA_guests.push(v); document.getElementById('sc_teamA_guest').value=''; renderGuestLists(); }
    };
    document.getElementById('sc_teamB_addGuest').onclick = () => {
      const v = document.getElementById('sc_teamB_guest').value.trim();
      if (v) { SC.teamB_guests.push(v); document.getElementById('sc_teamB_guest').value=''; renderGuestLists(); }
    };

    document.getElementById('sc_createMatch').onclick = async () => {
      const date = (document.getElementById('sc_date').value || '').trim();
      if (!date) return alert('Choose a session date.');

      const nameA = (document.getElementById('sc_teamA_name').value || 'Team A').trim();
      const nameB = (document.getElementById('sc_teamB_name').value || 'Team B').trim();

      const selA = [...document.getElementById('sc_teamA_players').selectedOptions].map(o => o.value);
      const selB = [...document.getElementById('sc_teamB_players').selectedOptions].map(o => o.value);
      if (!selA.length || !selB.length) return alert('Pick at least one player per team (or add guests).');

      const note = document.getElementById('sc_note').value || null;

      // 1) match
      const { data: m1, error: e1 } = await supabase.from('matches')
        .insert({ date, note })
        .select('id')
        .single();
      if (e1) return alert(e1.message);
      const match_id = m1.id;
      SC.matchId = match_id;
      document.getElementById('sc_matchId').textContent = match_id;

      // 2) teams with custom names
      const { data: teams, error: e2 } = await supabase.from('match_teams')
        .insert([{ match_id, name: nameA }, { match_id, name: nameB }])
        .select('id,name')
      ;
      if (e2) return alert(e2.message);

      const tSorted = [...teams].sort((a,b)=>a.name.localeCompare(b.name)); // consistent with summary/rules
      const teamA = tSorted[0].id;
      const teamB = tSorted[1].id;
      SC.teamA = teamA; SC.teamB = teamB;
      SC.teamA_name = tSorted[0].name;
      SC.teamB_name = tSorted[1].name;

      // 3) add team players (registered & guests)
      const tp = [];
      selA.forEach(pid => tp.push({ match_team_id: teamA, player_id: pid }));
      selB.forEach(pid => tp.push({ match_team_id: teamB, player_id: pid }));
      SC.teamA_guests.forEach(g => tp.push({ match_team_id: teamA, guest_name: g }));
      SC.teamB_guests.forEach(g => tp.push({ match_team_id: teamB, guest_name: g }));
      if (tp.length) {
        const { error: e3 } = await supabase.from('match_team_players').insert(tp);
        if (e3) return alert(e3.message);
      }

      // Seed error-player dropdown with all registered players from both teams
      const allPlayers = [...selA, ...selB];
      const { data: playersData } = await supabase.from('players').select('id,name').in('id', allPlayers);
      const errorSel = document.getElementById('sc_error_player');
      if (playersData && errorSel) {
        errorSel.innerHTML = '<option value="">‚Äî</option>' +
          playersData.sort((a,b)=>a.name.localeCompare(b.name)).map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      }

      // label live header
      document.getElementById('sc_teamA_name').textContent = SC.teamA_name;
      document.getElementById('sc_teamB_name').textContent = SC.teamB_name;

      // show live panel and reset score
      document.getElementById('sc_live').classList.remove('hidden');
      document.getElementById('sc_status').textContent = `Match created for ${date}`;
      const { a, b, seq } = await getCurrentScore(match_id);
      SC.seq = seq;
      updateScoreUI(a, b);
    };

    /* ========= RECORD POINTS & UNDO ========= */
    async function recordPoint(scoringTeamId) {
      if (!SC.matchId || !SC.teamA || !SC.teamB) return;

      // next sequence number
      SC.seq += 1;

      const reason = document.getElementById('sc_reason').value || 'rally';
      const error_player_id = document.getElementById('sc_error_player').value || null;
      const note = document.getElementById('sc_event_note').value || null;

      const payload = {
        match_id: SC.matchId,
        seq: SC.seq,
        scoring_team_id: scoringTeamId,
        reason,
        error_player_id: error_player_id || null,
        note
      };

      const { error } = await supabase.from('match_events').insert(payload);
      if (error) {
        // rollback seq if failed
        SC.seq -= 1;
        return alert(error.message);
      }

      const s = await getCurrentScore(SC.matchId);
      SC.seq = s.seq;
      updateScoreUI(s.a, s.b);
      document.getElementById('sc_event_note').value = '';
    }

    document.getElementById('sc_pointA').onclick = () => recordPoint(SC.teamA);
    document.getElementById('sc_pointB').onclick = () => recordPoint(SC.teamB);

    document.getElementById('sc_undo').onclick = async () => {
      if (!SC.matchId || SC.seq <= 0) return;
      const { error } = await supabase
        .from('match_events')
        .delete()
        .eq('match_id', SC.matchId)
        .eq('seq', SC.seq);
      if (error) return alert(error.message);
      SC.seq -= 1;
      const s = await getCurrentScore(SC.matchId);
      SC.seq = s.seq;
      updateScoreUI(s.a, s.b);
    };

    /* ========= INIT PLAYER LISTS FOR TEAM PICKERS ========= */
    async function initScoringPickers() {
      const players = await fetchPlayers();
      fillMultiSelectPlayers(document.getElementById('sc_teamA_players'), players);
      fillMultiSelectPlayers(document.getElementById('sc_teamB_players'), players);
    }
    document.addEventListener('DOMContentLoaded', initScoringPickers);

    // Forms (Admin)
    document.getElementById('playerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const payload = {
        name: form.get('name'),
        email: form.get('email') || null,
        is_active: true
      };
      const { error } = await supabase.from('players').insert(payload);
      if (error) alert(error.message);
      e.target.reset();
      refreshAll();
    });

    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const payload = {
        date: form.get('date'),
        amount: Number(form.get('amount')),
        description: form.get('description') || null
      };
      const { error } = await supabase.from('expenses').insert(payload);
      if (error) alert(error.message);
      e.target.reset();
      refreshAll();
    });

    document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const payload = {
        date: form.get('date'),
        player_id: form.get('player_id'),
        slots: Number(form.get('slots'))
      };
      // upsert by (date, player_id)
      const { error } = await supabase.from('attendance').upsert(payload, { onConflict: 'date,player_id' });
      if (error) alert(error.message);
      e.target.reset();
      refreshAll();
    });

    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const payload = {
        date: form.get('date'),
        player_id: form.get('player_id'),
        amount: Number(form.get('amount')),
        note: form.get('note') || null
      };
      const { error } = await supabase.from('payments').insert(payload);
      if (error) alert(error.message);
      e.target.reset();
      refreshAll();
    });

    document.getElementById('sc_finish').onclick = async () => {
      if (!SC.matchId) return alert('No active match.');
      const force = !!document.getElementById('sc_force').checked;

      const { data, error } = await supabase.rpc('finish_match', {
        p_match_id: SC.matchId,
        p_force: force
      });

      if (error) {
        alert(error.message);
        return;
      }

      const res = (data && data[0]) || {};
      const a = res.score_a ?? 0;
      const b = res.score_b ?? 0;

      // lock the UI
      ['sc_pointA','sc_pointB','sc_undo'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = true;
      });

      updateScoreUI(a, b);

      const winnerLabel = (res.winner_team_id === SC.teamA) ? document.getElementById('sc_teamA_name').textContent
                        : (res.winner_team_id === SC.teamB) ? document.getElementById('sc_teamB_name').textContent
                        : '‚Äî';
      document.getElementById('sc_status').textContent = `Finished ${a}‚Äì${b}. Winner: ${winnerLabel}`;
    };

    document.getElementById('pubLoadMatches').onclick = async () => {
      const dateStr = document.getElementById('pubMatchDate').value;
      if (!dateStr) { alert('Select a date'); return; }

      const [summary, stats] = await Promise.all([
        fetchMatchSummaryByDate(dateStr),
        fetchPlayerErrorStatsByDate(dateStr)
      ]);

      const matchIds = summary.map(s => s.match_id);
      const rosters = await fetchRostersByMatchIds(matchIds);

      renderMatchesByDate(dateStr, summary, rosters);
      renderPlayerErrorStats(dateStr, stats);
    };

    // (Optional) default to today
    document.addEventListener('DOMContentLoaded', () => {
      const el = document.getElementById('pubMatchDate');
      if (el && !el.value) {
        const d = new Date(); const iso = d.toISOString().slice(0,10);
        el.value = iso;
      }
    });

    // Boot
    refreshAll();
  </script>
</body>
</html>
