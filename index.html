<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Badminton Expenses</title>
  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <div class="max-w-6xl mx-auto p-4 sm:p-6">
    <header class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold">üè∏ Uncle Group Badminton Expenses</h1>
      <div>
        <button id="adminToggle" class="text-sm px-3 py-2 rounded bg-gray-200 hover:bg-gray-300">Admin</button>
      </div>
    </header>

    <section class="grid md:grid-cols-2 gap-6">
      <!-- Balances -->
      <div class="bg-white rounded-2xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3">Balances</h2>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="balancesTable">
            <thead>
              <tr class="bg-gray-100">
                <th class="text-left px-3 py-2">Player</th>
                <th class="text-right px-3 py-2">Owed</th>
                <th class="text-right px-3 py-2">Paid</th>
                <th class="text-right px-3 py-2">Balance</th>
              </tr>
            </thead>
            <tbody id="balancesBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Per-Player Total Attendance (Chart) -->
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Total Attendance by Player</h2>
          <select id="playerChartLimit" class="border rounded px-2 py-1 text-sm">
            <option value="10" selected>Top 10</option>
            <option value="20">Top 20</option>
            <option value="50">Top 50</option>
            <option value="0">All</option>
          </select>
        </div>

        <div id="playerChartWrapper" style="max-height: 620px; overflow:auto;">
          <canvas id="playerAttendanceChart"></canvas>
        </div>

        <p id="playerChartEmpty" class="text-sm text-gray-500 hidden">
          No attendance yet. Add some sessions in Admin ‚Üí Attendance.
        </p>

        <p class="text-xs text-gray-500 mt-2">
          Totals include <em>slots</em> (so +2 guests count as 2).
        </p>
      </div>

      <!-- Attendance (PUBLIC) -->
      <div class="bg-white rounded-2xl shadow p-4 md:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Attendance</h2>
          <div class="flex items-center gap-3">
            <div class="space-x-2">
              <button id="pubAttPrev" class="px-2 py-1 border rounded">Prev</button>
              <span id="pubAttPageInfo" class="text-sm text-gray-600">1 / 1 (0)</span>
              <button id="pubAttNext" class="px-2 py-1 border rounded">Next</button>
            </div>
            <label class="text-sm text-gray-600">
              Page size
              <select id="pubAttPageSize" class="border rounded px-2 py-1">
                <option>5</option><option selected>10</option><option>20</option><option>50</option>
              </select>
            </label>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="attendanceTable">
            <thead>
              <tr class="bg-gray-100">
                <th class="text-left px-3 py-2">Date</th>
                <th class="text-left px-3 py-2">Player</th>
                <th class="text-right px-3 py-2">Slots (+1/+2)</th>
              </tr>
            </thead>
            <tbody id="attendanceBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Payments (PUBLIC) -->
      <div class="bg-white rounded-2xl shadow p-4 md:col-span-2">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-semibold">Payments</h2>
          <div class="flex items-center gap-3">
            <div class="space-x-2">
              <button id="pubPayPrev" class="px-2 py-1 border rounded">Prev</button>
              <span id="pubPayPageInfo" class="text-sm text-gray-600">1 / 1 (0)</span>
              <button id="pubPayNext" class="px-2 py-1 border rounded">Next</button>
            </div>
            <label class="text-sm text-gray-600">
              Page size
              <select id="pubPayPageSize" class="border rounded px-2 py-1">
                <option>5</option><option selected>10</option><option>20</option><option>50</option>
              </select>
            </label>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full text-sm" id="paymentsTable">
            <thead>
              <tr class="bg-gray-100">
                <th class="text-left px-3 py-2">Date</th>
                <th class="text-left px-3 py-2">Player</th>
                <th class="text-right px-3 py-2">Amount</th>
                <th class="text-left px-3 py-2">Note</th>
              </tr>
            </thead>
            <tbody id="paymentsBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Admin Panel (hidden until toggled) -->
    <section id="adminPanel" class="mt-8 hidden">
      <div class="bg-white rounded-2xl shadow p-4">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Admin</h2>
          <div class="space-x-2">
            <button id="signInBtn" class="px-3 py-2 rounded bg-blue-600 text-white text-sm">Sign in</button>
            <button id="signOutBtn" class="px-3 py-2 rounded bg-gray-200 text-sm">Sign out</button>
          </div>
        </div>
        <p id="authStatus" class="text-sm text-gray-600 mt-2">Not signed in</p>
        <hr class="my-4"/>

        <div class="grid md:grid-cols-2 gap-6">
          <!-- Add Player -->
          <form id="playerForm" class="space-y-2">
            <h3 class="font-medium">Add Player</h3>
            <input class="w-full border rounded px-3 py-2" placeholder="Name" name="name" required />
            <input class="w-full border rounded px-3 py-2" placeholder="Email (optional)" name="email" />
            <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Add Player</button>
            <p class="text-xs text-gray-500">Active by default. Unique names.</p>
          </form>

          <!-- Add Expense -->
          <form id="expenseForm" class="space-y-2">
            <h3 class="font-medium">Add Expense (Court/Balls etc.)</h3>
            <input type="date" class="w-full border rounded px-3 py-2" name="date" required />
            <input type="number" step="0.01" class="w-full border rounded px-3 py-2" placeholder="Amount" name="amount" required />
            <input class="w-full border rounded px-3 py-2" placeholder="Description" name="description" />
            <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Add Expense</button>
          </form>

          <!-- Add Attendance -->
          <form id="attendanceForm" class="space-y-2">
            <h3 class="font-medium">Add Attendance</h3>
            <input type="date" class="w-full border rounded px-3 py-2" name="date" required />
            <select class="w-full border rounded px-3 py-2" name="player_id" id="attPlayer" required></select>
            <input type="number" class="w-full border rounded px-3 py-2" placeholder="Slots (1 or 2)" name="slots" min="1" value="1" required />
            <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Add/Update Attendance</button>
            <p class="text-xs text-gray-500">Unique per (date, player). Re-submit to update slots.</p>
          </form>

          <!-- Add Payment -->
          <form id="paymentForm" class="space-y-2">
            <h3 class="font-medium">Add Payment</h3>
            <input type="date" class="w-full border rounded px-3 py-2" name="date" required />
            <select class="w-full border rounded px-3 py-2" name="player_id" id="payPlayer" required></select>
            <input type="number" step="0.01" class="w-full border rounded px-3 py-2" placeholder="Amount" name="amount" required />
            <input class="w-full border rounded px-3 py-2" placeholder="Note" name="note" />
            <button class="px-3 py-2 rounded bg-emerald-600 text-white text-sm">Add Payment</button>
          </form>
        </div>
      </div>
    </section>

    <footer class="text-xs text-gray-500 mt-8">Built with Supabase + Tailwind. Static hosting friendly.</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

    // === CONFIG: Replace with your Supabase project details ===
    const SUPABASE_URL = "https://ioxtxbgqaognzxscgkly.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlveHR4YmdxYW9nbnp4c2Nna2x5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNTgxMDksImV4cCI6MjA3NTczNDEwOX0.oIST2TVUJbg4H0PziuNdLBcSHFERkkM2M29bHpsYE-E";

    // Init Supabase
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // MUST match Supabase Auth ‚Üí URL Configuration ‚Üí (Site URL + Redirect URL)
    const SITE_URL = "https://kailashr2k3.github.io/uncle-group-badminton-expenses/"; // keep the trailing slash
    /* ===== Init ===== */
    //const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ===== UI handles ===== */
    const balancesBody = document.getElementById('balancesBody');
    const attendanceBody = document.getElementById('attendanceBody');
    const paymentsBody = document.getElementById('paymentsBody');
    const adminPanel = document.getElementById('adminPanel');
    const adminToggle = document.getElementById('adminToggle');
    const authStatus = document.getElementById('authStatus');
    const signInBtn = document.getElementById('signInBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const attPlayer = document.getElementById('attPlayer');
    const payPlayer = document.getElementById('payPlayer');

    /* ===== Admin toggle/auth ===== */
    adminToggle.addEventListener('click', async () => {
      adminPanel.classList.toggle('hidden');
      if (!adminPanel.classList.contains('hidden')) {
        updateAuthStatus();
        const user = await getUser();
        if (!user) { await signInFlow(); }
      }
    });

    signInBtn?.addEventListener('click', signInFlow);
    signOutBtn?.addEventListener('click', async () => {
      await supabase.auth.signOut();
      updateAuthStatus();
    });

    async function getUser() {
      const { data: { user } } = await supabase.auth.getUser();
      return user || null;
    }

    async function signInFlow() {
      const email = prompt("Enter your admin email to receive a sign-in link:");
      if (!email) return;
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: SITE_URL }
      });
      if (error) alert(error.message);
      else alert("Magic link sent! Check your inbox.");
    }

    async function updateAuthStatus() {
      const { data: { user } } = await supabase.auth.getUser();
      authStatus.textContent = user ? `Signed in as ${user.email}` : 'Not signed in';
    }

    /* ===== Chart helpers ===== */
    let playerAttendanceChart;

    function groupAttendanceByPlayer(rows) {
      const map = new Map();
      for (const r of rows || []) {
        const name = r?.players?.name ?? 'Unknown';
        const slots = Number(r?.slots ?? 0);
        if (slots > 0) map.set(name, (map.get(name) || 0) + slots);
      }
      return [...map.entries()].sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));
    }

    function renderPlayerAttendanceChart(rows, limit = 10) {
      const canvas = document.getElementById('playerAttendanceChart');
      const wrapper = document.getElementById('playerChartWrapper');
      const emptyMsg = document.getElementById('playerChartEmpty');
      if (!canvas || !wrapper || !emptyMsg) return;

      let data = groupAttendanceByPlayer(rows);

      if (!data.length) {
        wrapper.classList.add('hidden');
        emptyMsg.classList.remove('hidden');
        if (playerAttendanceChart) { playerAttendanceChart.destroy(); playerAttendanceChart = null; }
        return;
      } else {
        wrapper.classList.remove('hidden');
        emptyMsg.classList.add('hidden');
      }

      if (limit && limit > 0) data = data.slice(0, limit);

      const labels = data.map(([name]) => name);
      const values = data.map(([, total]) => total);

      const perBar = 28, minH = 240, maxH = 700;
      canvas.height = Math.max(minH, Math.min(maxH, labels.length * perBar));

      if (playerAttendanceChart) playerAttendanceChart.destroy();

      playerAttendanceChart = new Chart(canvas, {
        type: 'bar',
        data: { labels, datasets: [{ label: 'Total attendance (slots)', data: values }] },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          indexAxis: 'y',
          scales: {
            x: { beginAtZero: true, title: { display: true, text: 'Slots' } },
            y: { ticks: { autoSkip: false } }
          },
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'nearest', intersect: false },
            datalabels: {
              anchor: 'end',
              align: 'right',
              color: '#111',
              font: { weight: 'bold' },
              formatter: (value, context) => {
                const name = context.chart.data.labels[context.dataIndex];
                return `${name}: ${value}`;
              },
              clip: false
            }
          },
          layout: { padding: { right: 8 } }
        },
        plugins: [ChartDataLabels]
      });
    }

    document.addEventListener('change', (e) => {
      if (e.target?.id === 'playerChartLimit') {
        const limit = Number(e.target.value);
        renderPlayerAttendanceChart(window.__lastAttendanceRows || [], limit);
      }
    });

    /* ===== Data fetch ===== */
    async function fetchPlayers() {
      const { data, error } = await supabase.from('players').select('*').order('name');
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function fetchAttendance() {
      const { data, error } = await supabase
        .from('attendance')
        .select('id,date,slots,player_id,players(name)')
        .order('date', { ascending: false });
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function fetchPayments() {
      const { data, error } = await supabase
        .from('payments')
        .select('id,date,amount,note,player_id,players(name)')
        .order('date', { ascending: false });
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function fetchBalances() {
      const { data, error } = await supabase
        .from('balance_view')
        .select('*')
        .order('name');
      if (error) { console.error(error); return []; }
      return data || [];
    }

    /* ===== Public pagination (Attendance/Payments only) ===== */
    const PUB_ATT = { data: [], page: 1, pageSize: 10 };
    const PUB_PAY = { data: [], page: 1, pageSize: 10 };

    function paginate(arr, page, size) {
      const start = (page - 1) * size;
      return arr.slice(start, start + size);
    }

    function renderPublicAttendance() {
      const container = document.getElementById('attendanceBody');
      if (!container) return;

      const total = PUB_ATT.data.length;
      const pages = Math.max(1, Math.ceil(total / PUB_ATT.pageSize));
      PUB_ATT.page = Math.min(Math.max(1, PUB_ATT.page), pages);

      const rows = paginate(PUB_ATT.data, PUB_ATT.page, PUB_ATT.pageSize);
      container.innerHTML = rows.map(r => `
        <tr class="border-b last:border-0">
          <td class="px-3 py-2">${r.date}</td>
          <td class="px-3 py-2">${r.players?.name ?? r.player_id}</td>
          <td class="px-3 py-2 text-right">${r.slots}</td>
        </tr>
      `).join('');

      const info = document.getElementById('pubAttPageInfo');
      if (info) info.textContent = `${PUB_ATT.page} / ${pages} (${total})`;
      document.getElementById('pubAttPrev').disabled = PUB_ATT.page <= 1;
      document.getElementById('pubAttNext').disabled = PUB_ATT.page >= pages;
    }

    function renderPublicPayments() {
      const container = document.getElementById('paymentsBody');
      if (!container) return;

      const total = PUB_PAY.data.length;
      const pages = Math.max(1, Math.ceil(total / PUB_PAY.pageSize));
      PUB_PAY.page = Math.min(Math.max(1, PUB_PAY.page), pages);

      const rows = paginate(PUB_PAY.data, PUB_PAY.page, PUB_PAY.pageSize);
      container.innerHTML = rows.map(r => `
        <tr class="border-b last:border-0">
          <td class="px-3 py-2">${r.date}</td>
          <td class="px-3 py-2">${r.players?.name ?? r.player_id}</td>
          <td class="px-3 py-2 text-right">$${Number(r.amount).toFixed(2)}</td>
          <td class="px-3 py-2">${r.note ?? ''}</td>
        </tr>
      `).join('');

      const info = document.getElementById('pubPayPageInfo');
      if (info) info.textContent = `${PUB_PAY.page} / ${pages} (${total})`;
      document.getElementById('pubPayPrev').disabled = PUB_PAY.page <= 1;
      document.getElementById('pubPayNext').disabled = PUB_PAY.page >= pages;
    }

    // Wire public pager controls
    document.addEventListener('DOMContentLoaded', () => {
      // Attendance
      document.getElementById('pubAttPrev').onclick = () => {
        if (PUB_ATT.page > 1) { PUB_ATT.page--; renderPublicAttendance(); }
      };
      document.getElementById('pubAttNext').onclick = () => {
        PUB_ATT.page++; renderPublicAttendance();
      };
      document.getElementById('pubAttPageSize').onchange = (e) => {
        PUB_ATT.pageSize = Number(e.target.value || 10);
        PUB_ATT.page = 1;
        renderPublicAttendance();
      };

      // Payments
      document.getElementById('pubPayPrev').onclick = () => {
        if (PUB_PAY.page > 1) { PUB_PAY.page--; renderPublicPayments(); }
      };
      document.getElementById('pubPayNext').onclick = () => {
        PUB_PAY.page++; renderPublicPayments();
      };
      document.getElementById('pubPayPageSize').onchange = (e) => {
        PUB_PAY.pageSize = Number(e.target.value || 10);
        PUB_PAY.page = 1;
        renderPublicPayments();
      };
    });

    /* ===== Render helpers ===== */
    function renderPlayers(players) {
      const attSel = document.getElementById('attPlayer');
      const paySel = document.getElementById('payPlayer');
      const opts = players.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      if (attSel) attSel.innerHTML = '<option value="" disabled selected>Select player</option>' + opts;
      if (paySel) paySel.innerHTML = '<option value="" disabled selected>Select player</option>' + opts;
    }

    function renderBalances(rows) {
      balancesBody.innerHTML = rows.map(r => {
        const bal = Number(r.balance);
        const cls = bal > 0 ? 'text-red-600' : (bal < 0 ? 'text-emerald-700' : '');
        return `
          <tr>
            <td class="px-3 py-2">${r.name}</td>
            <td class="px-3 py-2 text-right">$${Number(r.total_owed).toFixed(2)}</td>
            <td class="px-3 py-2 text-right">$${Number(r.total_paid).toFixed(2)}</td>
            <td class="px-3 py-2 text-right font-semibold ${cls}">$${bal.toFixed(2)}</td>
          </tr>`;
      }).join('');
    }

    /* ===== Initial load ===== */
    async function refreshAll() {
      updateAuthStatus();
      const [players, attendance, payments, balances] = await Promise.all([
        fetchPlayers(), fetchAttendance(), fetchPayments(), fetchBalances()
      ]);

      renderPlayers(players);
      renderBalances(balances);

      // public datasets + first render
      PUB_ATT.data = attendance || [];
      PUB_PAY.data = payments  || [];
      renderPublicAttendance();
      renderPublicPayments();

      // chart
      window.__lastAttendanceRows = attendance;
      const limitSel = document.getElementById('playerChartLimit');
      const limit = limitSel ? Number(limitSel.value) : 10;
      renderPlayerAttendanceChart(attendance, limit);
    }

    // Forms (Admin)
    document.getElementById('playerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const payload = {
        name: form.get('name'),
        email: form.get('email') || null,
        is_active: true
      };
      const { error } = await supabase.from('players').insert(payload);
      if (error) alert(error.message);
      e.target.reset();
      refreshAll();
    });

    document.getElementById('expenseForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const payload = {
        date: form.get('date'),
        amount: Number(form.get('amount')),
        description: form.get('description') || null
      };
      const { error } = await supabase.from('expenses').insert(payload);
      if (error) alert(error.message);
      e.target.reset();
      refreshAll();
    });

    document.getElementById('attendanceForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const payload = {
        date: form.get('date'),
        player_id: form.get('player_id'),
        slots: Number(form.get('slots'))
      };
      // upsert by (date, player_id)
      const { error } = await supabase.from('attendance').upsert(payload, { onConflict: 'date,player_id' });
      if (error) alert(error.message);
      e.target.reset();
      refreshAll();
    });

    document.getElementById('paymentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = new FormData(e.target);
      const payload = {
        date: form.get('date'),
        player_id: form.get('player_id'),
        amount: Number(form.get('amount')),
        note: form.get('note') || null
      };
      const { error } = await supabase.from('payments').insert(payload);
      if (error) alert(error.message);
      e.target.reset();
      refreshAll();
    });

    // Boot
    refreshAll();
  </script>
</body>
</html>
